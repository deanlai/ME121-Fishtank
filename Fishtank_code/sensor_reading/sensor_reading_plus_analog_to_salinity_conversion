//--------------------------------------------------------
// Sensor readings program with conversion from analog output to wt% salinity
// Version 1.1
// 1/27/20
// The North American Council on Aquatic Housing and Development
//NOTE: To run this code you must have downloaded the LiquidCrystal_I2C library (and added it to the sketch from the IDE), 
//which is in Whitman's folder in the main directory
//--------------------------------------------------------

// delcare global pins
const int SALINITY_POWER_PIN = 8;
#include <Wire.h> //Include wire (i2c comm) and liquidcrystal libraries 
#include <LiquidCrystal_I2C.h>
LiquidCrystal_I2C lcd = LiquidCrystal_I2C(0x27, 20, 4); //20x4 LCD screen, 0x27 is the address 

void setup(){
pinMode(SALINITY_POWER_PIN, OUTPUT);
Serial.begin(9600);
lcd.init(); //initiate LCD
lcd. backlight(); //backlight on

}

void loop(){
    // declare local pins
    const int SALINITY_READING_PIN = A0;

    // setup variables
    int numReadings = 30;
    int salinityReading = 0;
    float voltage = 0.0;
    float c1 = 944.3844;
    float c2 = 1/0.1368; //constant inverse to solve for salinity
    float salinityPercentage, consteq;

    // take a salinity reading
    salinityReading = takeReading(SALINITY_POWER_PIN, SALINITY_READING_PIN, numReadings);
    voltage = salinityReading*5/1023.0;
    int currentTime = millis();
    
    // Convert from analog to salinity percentage
    consteq = (salinityReading/c1);
    salinityPercentage = pow(consteq, c2);

    /* Comment out whichever Serial dialog is not needed
    // Print to Serial Monitor (for humans)
    Serial.print("Time: ");
    Serial.print(currentTime);
    Serial.print("  |  Voltage: ");
    Serial.println(voltage);
    */

    // Print to Serial Monitor (for data analysis)
    Serial.print(salinityReading);
    Serial.print(" ");
    Serial.print(salinityPercentage);
    Serial.println();

    //Print to LCD Screen
    lcd.setCursor(0,1);
    lcd.print("Percent salt: ");
    lcd.print(salinityPercentage, 4); //to 4 decimal places accuracy
    lcd.setCursor(0, 2);
    lcd.print("Analog read: ");
    lcd.print(salinityReading);
    delay(250); //delay between refresh
     
}

float takeReading(int powerPin, int readingPin, int numReadings){
    float sum = 0.0;
    digitalWrite(powerPin, 1); // Turn sensor on
    delay(100); // Allow power to settle
    for(int i=0; i<numReadings; i++){ // Take readings and sum
        sum += analogRead(readingPin);
        delay(10);
    }
    digitalWrite(powerPin, 0); // Turn sensor off
    sum /= numReadings; // Average sum over readings
    return sum;
}
